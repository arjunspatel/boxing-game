<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxing Game - First Person 3D with Motion Control</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>ðŸ¥Š Boxing Game</h1>
    <p class="subtitle">First Person 3D View with AI Depth Sensing</p>
    
    <div class="game-container">
        <!-- 3D Game View -->
        <div class="game-area">
            <h2>First Person View</h2>
            <div id="game3DContainer" class="game-3d-container">
                <!-- Three.js canvas will be inserted here -->
            </div>
            <div class="current-stance">
                Punch Power: <span id="punchPower">Ready</span>
            </div>
        </div>
        
        <!-- Camera Feed -->
        <div class="camera-section">
            <h2>Camera Feed</h2>
            <div class="camera-container">
                <video id="cameraFeed" playsinline autoplay muted></video>
                <canvas id="cameraOverlay"></canvas>
                
                <!-- Grid overlay removed for cleaner, smoother experience -->
                
                <!-- Loading overlay -->
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading MediaPipe...</div>
                </div>
            </div>
            
            <p class="camera-status" id="cameraStatus">Loading...</p>
            <button class="start-btn" id="startBtn" disabled>Start Camera</button>
            
            <!-- Detection Info -->
            <div class="detection-info">
                <h4>Hand Detection & Depth</h4>
                <div class="hand-position">
                    <div class="hand-indicator left"></div>
                    <div class="hand-info">
                        <span>Left Hand: <span id="leftHandPos">Not detected</span></span>
                        <span id="leftHandDepth" class="depth-info"></span>
                    </div>
                </div>
                <div class="hand-position">
                    <div class="hand-indicator right"></div>
                    <div class="hand-info">
                        <span>Right Hand: <span id="rightHandPos">Not detected</span></span>
                        <span id="rightHandDepth" class="depth-info"></span>
                    </div>
                </div>
            </div>
            
            <!-- Punch Log -->
            <div class="punch-log">
                <h4>Punch Log</h4>
                <div id="punchLogList"></div>
            </div>
        </div>
        
        <!-- Debug Panel - Punch Detection Ingredients -->
        <div class="debug-panel">
            <h2>ðŸ”¬ Punch Detection Debug</h2>
            <p class="debug-subtitle">All ingredients that go into detecting a punch</p>
            
            <!-- Left Hand Debug -->
            <div class="hand-debug-section">
                <h3 class="left-title">Left Hand</h3>
                <div class="debug-grid" id="leftDebugGrid">
                    <!-- Raw Palm Z -->
                    <div class="debug-item">
                        <label>Raw Palm Z</label>
                        <div class="debug-meter">
                            <div class="meter-track">
                                <div class="meter-fill" id="leftPalmZ"></div>
                                <div class="meter-center"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="leftPalmZVal">0.000</span>
                    </div>
                    
                    <!-- Hand Scale -->
                    <div class="debug-item">
                        <label>Hand Scale</label>
                        <div class="debug-meter">
                            <div class="meter-track scale-meter">
                                <div class="meter-fill scale" id="leftScale"></div>
                                <div class="meter-reference" id="leftScaleRef"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="leftScaleVal">0.150</span>
                    </div>
                    
                    <!-- Combined Depth -->
                    <div class="debug-item">
                        <label>Combined Depth</label>
                        <div class="debug-meter">
                            <div class="meter-track">
                                <div class="meter-fill" id="leftDepth"></div>
                                <div class="meter-center"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="leftDepthVal">0.000</span>
                    </div>
                    
                    <!-- Velocity (KEY for punch detection!) -->
                    <div class="debug-item velocity-item">
                        <label>âš¡ VELOCITY</label>
                        <div class="debug-meter">
                            <div class="meter-track velocity-track">
                                <div class="meter-fill velocity" id="leftVelocity"></div>
                                <div class="meter-center"></div>
                                <div class="velocity-threshold-line" id="leftThreshold"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="leftVelocityVal">0.0000</span>
                    </div>
                    
                    <!-- Fist Detection -->
                    <div class="debug-item">
                        <label>Fist Detected</label>
                        <div class="debug-indicator" id="leftFist">NO</div>
                    </div>
                    
                    <!-- Punch State -->
                    <div class="debug-item">
                        <label>Punch State</label>
                        <div class="debug-indicator punch-state" id="leftPunch">IDLE</div>
                    </div>
                    
                    <!-- Punch Power -->
                    <div class="debug-item power-item">
                        <label>Punch Power</label>
                        <div class="power-bar">
                            <div class="power-fill" id="leftPower"></div>
                        </div>
                        <span class="debug-value" id="leftPowerVal">0%</span>
                    </div>
                </div>
                
                <!-- Velocity Graph -->
                <div class="velocity-graph-container">
                    <label>Velocity History</label>
                    <canvas id="leftVelocityGraph" width="300" height="60"></canvas>
                </div>
            </div>
            
            <!-- Right Hand Debug -->
            <div class="hand-debug-section">
                <h3 class="right-title">Right Hand</h3>
                <div class="debug-grid" id="rightDebugGrid">
                    <!-- Raw Palm Z -->
                    <div class="debug-item">
                        <label>Raw Palm Z</label>
                        <div class="debug-meter">
                            <div class="meter-track">
                                <div class="meter-fill" id="rightPalmZ"></div>
                                <div class="meter-center"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="rightPalmZVal">0.000</span>
                    </div>
                    
                    <!-- Hand Scale -->
                    <div class="debug-item">
                        <label>Hand Scale</label>
                        <div class="debug-meter">
                            <div class="meter-track scale-meter">
                                <div class="meter-fill scale" id="rightScale"></div>
                                <div class="meter-reference" id="rightScaleRef"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="rightScaleVal">0.150</span>
                    </div>
                    
                    <!-- Combined Depth -->
                    <div class="debug-item">
                        <label>Combined Depth</label>
                        <div class="debug-meter">
                            <div class="meter-track">
                                <div class="meter-fill" id="rightDepth"></div>
                                <div class="meter-center"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="rightDepthVal">0.000</span>
                    </div>
                    
                    <!-- Velocity (KEY for punch detection!) -->
                    <div class="debug-item velocity-item">
                        <label>âš¡ VELOCITY</label>
                        <div class="debug-meter">
                            <div class="meter-track velocity-track">
                                <div class="meter-fill velocity" id="rightVelocity"></div>
                                <div class="meter-center"></div>
                                <div class="velocity-threshold-line" id="rightThreshold"></div>
                            </div>
                        </div>
                        <span class="debug-value" id="rightVelocityVal">0.0000</span>
                    </div>
                    
                    <!-- Fist Detection -->
                    <div class="debug-item">
                        <label>Fist Detected</label>
                        <div class="debug-indicator" id="rightFist">NO</div>
                    </div>
                    
                    <!-- Punch State -->
                    <div class="debug-item">
                        <label>Punch State</label>
                        <div class="debug-indicator punch-state" id="rightPunch">IDLE</div>
                    </div>
                    
                    <!-- Punch Power -->
                    <div class="debug-item power-item">
                        <label>Punch Power</label>
                        <div class="power-bar">
                            <div class="power-fill" id="rightPower"></div>
                        </div>
                        <span class="debug-value" id="rightPowerVal">0%</span>
                    </div>
                </div>
                
                <!-- Velocity Graph -->
                <div class="velocity-graph-container">
                    <label>Velocity History</label>
                    <canvas id="rightVelocityGraph" width="300" height="60"></canvas>
                </div>
            </div>
            
            <!-- Threshold Info -->
            <div class="threshold-info">
                <h4>Detection Thresholds</h4>
                <div class="threshold-row">
                    <span class="threshold-label">Velocity Threshold:</span>
                    <span class="threshold-value" id="velocityThresholdVal">-0.006</span>
                    <span class="threshold-desc">(velocity must be below this to trigger punch)</span>
                </div>
                <div class="threshold-row">
                    <span class="threshold-label">Punch Cooldown:</span>
                    <span class="threshold-value">80ms</span>
                </div>
                <div class="threshold-row">
                    <span class="threshold-label">Depth Smoothing:</span>
                    <span class="threshold-value">0.7</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="instructions">
        <h3>How to Play - Forward Punch Detection</h3>
        <ul>
            <li><span class="key-highlight">Punch forward</span> â†’ Your 3D gloves punch forward in the game</li>
            <li><span class="key-highlight">Move hands left/right</span> â†’ Gloves follow your hand position</li>
            <li><span class="key-highlight">Move hands up/down</span> â†’ Adjust glove height</li>
            <li><span class="key-highlight">Fast forward motion</span> â†’ Stronger punch with more effect</li>
        </ul>
        <p><strong>AI Depth Sensing:</strong> The system tracks your hand depth using MediaPipe's z-coordinates 
        combined with hand scale estimation. When you punch forward, the velocity is calculated to detect punch power.</p>
        
        <h4>Depth Indicator Legend</h4>
        <ul>
            <li><span class="legend-item green">Green bar/arrow</span> = Moving forward (toward camera/punching)</li>
            <li><span class="legend-item orange">Orange bar/arrow</span> = Moving backward (away from camera)</li>
            <li><span class="legend-item yellow">Yellow ring</span> = Punch detected!</li>
        </ul>
        
        <h4>ðŸ”¬ Debug Panel - Punch Detection Ingredients</h4>
        <p>The debug panel shows <strong>all the data</strong> that goes into detecting a punch:</p>
        <ul>
            <li><strong>Raw Palm Z:</strong> The raw depth value from MediaPipe's z-coordinates (negative = closer to camera)</li>
            <li><strong>Hand Scale:</strong> Distance between wrist and middle finger MCP. Larger = closer to camera. White line shows reference size.</li>
            <li><strong>Combined Depth:</strong> Weighted combination of Palm Z (60%) and Scale depth (40%), amplified 1.5x</li>
            <li><strong>âš¡ VELOCITY:</strong> The rate of change in depth - <em>this is the key trigger for punch detection!</em> When velocity crosses the red threshold line (going left/negative), a punch is registered.</li>
            <li><strong>Fist Detected:</strong> Whether 3+ fingers are curled (fingertips closer to wrist than knuckles)</li>
            <li><strong>Punch State:</strong> IDLE or PUNCHING - shows when the system has registered a punch</li>
            <li><strong>Punch Power:</strong> 0-100% based on how fast you punched (higher velocity = more power)</li>
            <li><strong>Velocity History Graph:</strong> Real-time graph showing velocity over time. Yellow highlights show when threshold was crossed.</li>
        </ul>
        
        <h4>Using Mixamo Models</h4>
        <p>To use real 3D character models from Mixamo:</p>
        <ol>
            <li>Visit <a href="https://www.mixamo.com" target="_blank">mixamo.com</a> and create a free account</li>
            <li>Download a character model in FBX or GLB format</li>
            <li>Convert to GLB if needed using <a href="https://gltf.report/" target="_blank">gltf.report</a></li>
            <li>Place the file in this project folder</li>
            <li>Call <code>BoxingGame3D.setGloveModel('your-model.glb')</code> in the console</li>
        </ol>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <!-- MediaPipe Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- Game Scripts -->
    <script src="depthSensor.js"></script>
    <script src="game3d.js"></script>
    <script src="game.js"></script>
    <script src="camera.js"></script>
    
    <script>
        // Punch log functionality
        const punchLog = [];
        const maxLogEntries = 5;
        
        function addPunchToLog(punchData) {
            const entry = {
                time: new Date().toLocaleTimeString(),
                hand: punchData.hand,
                power: Math.round(punchData.power * 100)
            };
            
            punchLog.unshift(entry);
            if (punchLog.length > maxLogEntries) {
                punchLog.pop();
            }
            
            updatePunchLogDisplay();
            updatePunchPowerDisplay(punchData);
        }
        
        function updatePunchLogDisplay() {
            const logEl = document.getElementById('punchLogList');
            if (!logEl) return;
            
            logEl.innerHTML = punchLog.map(entry => 
                `<div class="punch-entry ${entry.hand}">
                    <span class="punch-time">${entry.time}</span>
                    <span class="punch-hand">${entry.hand.toUpperCase()}</span>
                    <span class="punch-power-bar">
                        <span class="punch-power-fill" style="width: ${entry.power}%"></span>
                    </span>
                    <span class="punch-power-text">${entry.power}%</span>
                </div>`
            ).join('');
        }
        
        function updatePunchPowerDisplay(punchData) {
            const powerEl = document.getElementById('punchPower');
            if (!powerEl) return;
            
            const power = Math.round(punchData.power * 100);
            powerEl.textContent = `${punchData.hand.toUpperCase()} - ${power}% Power!`;
            powerEl.className = 'punch-active';
            
            setTimeout(() => {
                powerEl.textContent = 'Ready';
                powerEl.className = '';
            }, 1000);
        }
        
        // Initialize game and camera detection
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize the 3D boxing game
            const game3dSuccess = BoxingGame3D.init('game3DContainer');
            if (!game3dSuccess) {
                console.error('Failed to initialize 3D game');
            }
            
            // Initialize legacy 2D game (optional, for fallback)
            // BoxingGame.init('gameCanvas');
            
            // Initialize camera detection
            await CameraDetection.init();
            
            // Set up punch callback for logging
            CameraDetection.setOnPunchDetected((punchData) => {
                addPunchToLog(punchData);
            });
        });
    </script>
</body>
</html>
